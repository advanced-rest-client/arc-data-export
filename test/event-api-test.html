<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="data-generator.js"></script>
    <script src="../../chance/dist/chance.min.js"></script>
    <link rel="import" href="../arc-data-export.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <arc-data-export db-chunk="10"></arc-data-export>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, DataGenerator, sinon */
    suite('Querying for data - events API', function() {

      function fire(type, detail, node) {
        const e = new CustomEvent(type, {
          detail: detail,
          bubbles: true,
          composed: true,
          cancelable: true
        });
        (node || document.body).dispatchEvent(e);
        return e;
      }

      suite('export-user-data', function() {
        const sampleSzie = 100;

        suiteSetup(function() {
          this.timeout(20000);
          return DataGenerator.generateData(sampleSzie);
        });

        suiteTeardown(function() {
          return DataGenerator.destroyData();
        });

        let element;
        setup(function() {
          element = fixture('basic');
        });

        test('Creates an export object', function() {
          const e = fire('export-user-data', {
            type: 'saved'
          });
          assert.isTrue(e.defaultPrevented);
          return e.detail.result
          .then((result) => {
            assert.typeOf(result, 'object', 'result is an object');
            assert.typeOf(result.createdAt, 'string', 'createdAt is set');
            assert.equal(result.kind, 'ARC#AllDataExport', 'Kind is set');
            assert.equal(result.version, 'unknown', 'version is set');
          });
        });

        test('Creates saved data export', function() {
          const e = fire('export-user-data', {
            type: 'saved'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result.projects, 'array', 'projects are set');
            assert.isAbove(result.projects.length, 0, 'projects are not empty');

            assert.typeOf(result.requests, 'array', 'requests are set');
            assert.lengthOf(result.requests, sampleSzie, 'Requests size is OK');
          });
        });

        test('Creates history data export', function() {
          const e = fire('export-user-data', {
            type: 'history'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result.history, 'array', 'history are set');
            assert.lengthOf(result.history, sampleSzie, 'history are not empty');
          });
        });

        test('Creates websocket URL history data export', function() {
          const e = fire('export-user-data', {
            type: 'websocket'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result['websocket-url-history'], 'array', 'websocket are set');
            assert.lengthOf(result['websocket-url-history'], 25, 'websocket are not empty');
          });
        });

        test('Creates URL history data export', function() {
          const e = fire('export-user-data', {
            type: 'history-url'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result['url-history'], 'array', 'url-history are set');
            assert.lengthOf(result['url-history'], 25, 'url-history are not empty');
          });
        });

        test('Creates variables data export', function() {
          const e = fire('export-user-data', {
            type: 'variables'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result.variables, 'array', 'variables are set');
            assert.lengthOf(result.variables, 25, 'variables are not empty');
          });
        });

        test('Creates headers-sets data export', function() {
          const e = fire('export-user-data', {
            type: 'headers-sets'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result['headers-sets'], 'array', 'headers-sets are set');
            assert.lengthOf(result['headers-sets'], 25, 'headers-sets are not empty');
          });
        });

        test('Creates cookies data export', function() {
          const e = fire('export-user-data', {
            type: 'cookies'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result.cookies, 'array', 'cookies are set');
            assert.lengthOf(result.cookies, 25, 'cookies are not empty');
          });
        });

        test('Creates headers-sets data export', function() {
          const e = fire('export-user-data', {
            type: 'auth'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result['auth-data'], 'array', 'auth-data are set');
            assert.lengthOf(result['auth-data'], 25, 'auth-data are not empty');
          });
        });

        test('Creates full data export', function() {
          const e = fire('export-user-data', {
            type: 'all'
          });
          return e.detail.result
          .then(result => {
            assert.typeOf(result['auth-data'], 'array', 'auth-data are set');
            assert.typeOf(result.cookies, 'array', 'cookies are set');
            assert.typeOf(result['headers-sets'], 'array', 'headers-sets are set');
            assert.typeOf(result.variables, 'array', 'variables are set');
            assert.typeOf(result['url-history'], 'array', 'url-history are set');
            assert.typeOf(result['websocket-url-history'], 'array', 'websocket are set');
            assert.typeOf(result.history, 'array', 'history are set');
            assert.typeOf(result.projects, 'array', 'projects are set');
            assert.typeOf(result.requests, 'array', 'requests are set');
          });
        });

        test('Fires export-data custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('export-data', spy);
          const e = fire('export-user-data', {
            type: 'all'
          });
          return e.detail.result
          .then(() => {
            assert.isTrue(spy.calledOnce);
          });
        });

        test('export-data event contains export object', function() {
          let eventData;
          element.addEventListener('export-data', function(e) {
            eventData = e.detail;
          });
          const e = fire('export-user-data', {
            type: 'all'
          });
          return e.detail.result
          .then(() => {
            assert.typeOf(eventData, 'object');
            assert.equal(eventData.type, 'application/json');
            assert.typeOf(eventData.data, 'object');
            assert.equal(eventData.data.kind, 'ARC#AllDataExport');
            assert.typeOf(eventData.file, 'string');
          });
        });

        test('Fires google-drive-data-save custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('google-drive-data-save', spy);
          const e = fire('export-user-data', {
            type: 'all',
            destination: 'drive'
          });
          return e.detail.result
          .then(() => {
            assert.isTrue(spy.calledOnce);
          });
        });

        test('google-drive-data-save event contains export object', function() {
          let eventData;
          element.addEventListener('google-drive-data-save', function clb(e) {
            element.removeEventListener('google-drive-data-save', clb);
            eventData = e.detail;
          });
          const e = fire('export-user-data', {
            type: 'all',
            destination: 'drive'
          });
          return e.detail.result
          .then(() => {
            assert.typeOf(eventData, 'object');
            assert.equal(eventData.contentType, 'application/json');
            assert.typeOf(eventData.content, 'object');
            assert.typeOf(eventData.file, 'string');
          });
        });
      });

      suite('export-project', function() {
        let element;
        let project;
        let requests;
        let variables;

        suiteSetup(function() {
          this.timeout(20000);
          project = DataGenerator.createProjectObject();
          requests = DataGenerator.generateRequests(project._id, 2000);
          variables = DataGenerator.generateVariables();
        });

        setup(function() {
          element = fixture('basic');
        });

        function fireProject() {
          return fire('export-project', {
            project: project,
            requests: requests,
            variables: variables,
            destination: 'file',
            file: 'test-file'
          });
        }

        test('Event is canceled', function() {
          const e = fireProject();
          assert.isTrue(e.defaultPrevented);
        });

        test('Returns a promise', function() {
          const e = fireProject();
          const result = e.detail.result;
          assert.typeOf(result.then, 'function');
        });

        test('Fires export-data custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('export-data', spy);
          fireProject();
          assert.isTrue(spy.calledOnce);
        });

        test('export-data contains project object', function(done) {
          element.addEventListener('export-data', function clb(e) {
            element.removeEventListener('export-data', clb);
            const result = e.detail.data;
            assert.typeOf(result, 'object', 'result is an object');
            assert.typeOf(result.createdAt, 'string', 'createdAt is set');
            assert.equal(result.kind, 'ARC#Project', 'Kind is set');
            assert.equal(result.version, 'unknown', 'version is set');
            done();
          });
          fireProject();
        });

        test('Adds project to the projects listt', function(done) {
          element.addEventListener('export-data', function clb(e) {
            element.removeEventListener('export-data', clb);
            const result = e.detail.data;
            assert.typeOf(result.projects, 'array', 'projects is an array');
            assert.lengthOf(result.projects, 1, 'projects contains one item');
            done();
          });
          fireProject();
        });

        test('Adds requests property', function(done) {
          element.addEventListener('export-data', function clb(e) {
            element.removeEventListener('export-data', clb);
            const result = e.detail.data;
            assert.typeOf(result.requests, 'array', 'requests is an array');
            assert.isAbove(result.requests.length, 0, 'requests contains list of requests');
            done();
          });
          fireProject();
        });

        test('Adds variables property', function(done) {
          element.addEventListener('export-data', function clb(e) {
            element.removeEventListener('export-data', clb);
            const result = e.detail.data;
            assert.typeOf(result.variables, 'array', 'variables is an array');
            assert.isAbove(result.variables.length, 0, 'variables is not empty');
            done();
          });
          fireProject();
        });

        test('export-data contains meta data', function(done) {
          element.addEventListener('export-data', function clb(e) {
            element.removeEventListener('export-data', clb);
            assert.equal(e.detail.file, 'test-file');
            assert.equal(e.detail.type, 'application/json');
            done();
          });
          fireProject();
        });
      });

      suite('export-request', function() {
        let element;
        let request;
        let variables;
        let callback;

        suiteSetup(function() {
          request = DataGenerator.generateRequests(undefined, 1)[0];
          variables = DataGenerator.generateVariables();
          callback = function(e) {
            e.preventDefault();
            e.detail.result = Promise.resolve({});
          };
          window.addEventListener('export-data', callback);
        });

        suiteTeardown(function() {
          window.removeEventListener('export-data', callback);
        });

        setup(function() {
          element = fixture('basic');
        });

        function fireProject() {
          return fire('export-request', {
            request: request,
            variables: variables
          });
        }

        test('Event is canceled', function() {
          const e = fireProject();
          assert.isTrue(e.defaultPrevented);
        });

        test('Creates export object', function() {
          const e = fireProject();
          return e.detail.result
          .then((result) => {
            assert.typeOf(result, 'object', 'result is an object');
            assert.typeOf(result.createdAt, 'string', 'createdAt is set');
            assert.equal(result.kind, 'ARC#Request', 'Kind is set');
            assert.equal(result.version, 'unknown', 'version is set');
          });
        });

        test('Adds request property', function() {
          const e = fireProject();
          return e.detail.result
          .then((result) => {
            assert.typeOf(result.requests, 'array', 'requests is an array');
            assert.lengthOf(result.requests, 1, 'requests contains one item');
          });
        });

        test('Adds variables property', function() {
          const e = fireProject();
          return e.detail.result
          .then((result) => {
            assert.typeOf(result.variables, 'array', 'variables is an array');
            assert.isAbove(result.variables.length, 0, 'variables is not empty');
          });
        });

        test('Fires export-data custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('export-data', spy);
          fireProject();
          assert.isTrue(spy.calledOnce);
        });
      });

      suite('export-requests', function() {
        let element;
        let requests;
        let variables;
        let callback;
        suiteSetup(function() {
          this.timeout(20000);
          requests = DataGenerator.generateRequests(undefined, 2000);
          variables = DataGenerator.generateVariables();
          callback = function(e) {
            e.preventDefault();
            e.detail.result = Promise.resolve({});
          };
          window.addEventListener('export-data', callback);
        });

        suiteTeardown(function() {
          window.removeEventListener('export-data', callback);
        });

        setup(function() {
          element = fixture('basic');
        });

        function fireProject() {
          return fire('export-requests', {
            requests: requests,
            variables: variables
          });
        }

        test('Event is canceled', function() {
          const e = fireProject();
          assert.isTrue(e.defaultPrevented);
        });

        test('Creates export object', function() {
          const e = fireProject();
          return e.detail.result
          .then(result => {
            assert.typeOf(result, 'object', 'result is an object');
            assert.typeOf(result.createdAt, 'string', 'createdAt is set');
            assert.equal(result.kind, 'ARC#RequestsList', 'Kind is set');
            assert.equal(result.version, 'unknown', 'version is set');
          });
        });

        test('Adds requests property', function() {
          const e = fireProject();
          return e.detail.result
          .then(result => {
            assert.typeOf(result.requests, 'array', 'requests is an array');
            assert.lengthOf(result.requests, 2000, 'requests is not empty');
          });
        });

        test('Adds variables property', function() {
          const e = fireProject();
          return e.detail.result
          .then(result => {
            assert.typeOf(result.variables, 'array', 'variables is an array');
            assert.isAbove(result.variables.length, 0, 'variables is not empty');
          });
        });

        test('Fires export-data custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('export-data', spy);
          fireProject();
          assert.isTrue(spy.calledOnce);
        });
      });

      suite('export-create-object', function() {
        let element;
        let requests;
        let variables;
        let project;
        let cookies;
        const kind = 'ARC#TEST';
        suiteSetup(function() {
          this.timeout(20000);
          project = DataGenerator.createProjectObject();
          requests = DataGenerator.generateRequests(project._id, 2000);
          variables = DataGenerator.generateVariables();
          cookies = DataGenerator.generateCookies();
        });

        setup(function() {
          element = fixture('basic');
        });

        function fireExport() {
          return fire('export-create-object', {
            types: {
              projects: [project],
              requests: requests,
              variables: variables,
              cookies: cookies,
            },
            kind: kind
          });
        }

        test('Event is canceled', function() {
          const e = fireExport();
          assert.isTrue(e.defaultPrevented);
        });

        test('Creates export object', function() {
          const e = fireExport();
          const result = e.detail.result;
          assert.typeOf(result, 'object', 'result is an object');
          assert.typeOf(result.createdAt, 'string', 'createdAt is set');
          assert.equal(result.kind, kind, 'Kind is set');
          assert.equal(result.version, 'unknown', 'version is set');
        });

        test('Adds requests property', function() {
          const e = fireExport();
          const result = e.detail.result;
          assert.typeOf(result.requests, 'array', 'requests is an array');
          assert.lengthOf(result.requests, 2000, 'requests is not empty');
        });

        test('Adds variables property', function() {
          const e = fireExport();
          const result = e.detail.result;
          assert.typeOf(result.variables, 'array', 'variables is an array');
          assert.isAbove(result.variables.length, 0, 'variables is not empty');
        });

        test('Adds projects property', function() {
          const e = fireExport();
          const result = e.detail.result;
          assert.typeOf(result.projects, 'array', 'projects is an array');
          assert.lengthOf(result.projects, 1, 'projects has one item');
        });

        test('Adds cookies property', function() {
          const e = fireExport();
          const result = e.detail.result;
          assert.typeOf(result.cookies, 'array', 'cookies is an array');
          assert.lengthOf(result.cookies, 25, 'cookies has all items');
        });
      });
    });
    </script>

  </body>
</html>
