<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../chance/dist/chance.min.js"></script>
    <script src="data-helper.js"></script>
    <link rel="import" href="../../app-pouchdb/pouchdb.html">
    <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
    <link rel="import" href="../arc-data-export.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <arc-data-export db-chunk="10"></arc-data-export>
      </template>
    </test-fixture>

    <script>
    /* global DataHelper, DataGenerator */
    suite('Exporting ARC data - events API', function() {
      function fire(detail, type) {
        type = type || 'arc-data-export';
        const e = new CustomEvent(type, {
          detail,
          bubbles: true,
          composed: true,
          cancelable: true
        });
        document.body.dispatchEvent(e);
        return e;
      }

      function waitUntilFileEvent(done) {
        window.addEventListener('file-data-save', function f(e) {
          window.removeEventListener('file-data-save', f);
          done(e);
        });
      }

      function waitUntilDriveEvent(done) {
        window.addEventListener('google-drive-data-save', function f(e) {
          window.removeEventListener('google-drive-data-save', f);
          done(e);
        });
      }

      suite('arc-data-export', function() {
        const sampleSzie = 5;

        suiteSetup(function() {
          this.timeout(20000);
          return DataHelper.generateData(sampleSzie);
        });

        suiteTeardown(function() {
          return DataGenerator.destroyAll();
        });

        let element;
        setup(function() {
          element = fixture('basic');
        });

        test('Cancels the event', function() {
          waitUntilFileEvent((e) => {
            e.preventDefault();
          });
          const e = fire({
            options: {
              provider: 'file',
              file: 'file-123'
            },
            data: {
              saved: true,
            }
          });
          assert.isTrue(e.defaultPrevented);
          return e.detail.result;
        });

        test('Ignores cancelled events', function() {
          document.body.addEventListener('arc-data-export', function f(e) {
            document.body.removeEventListener('arc-data-export', f);
            e.preventDefault();
          });
          const e = fire({
            options: {
              provider: 'file',
              file: 'file-123'
            },
            destination: 'file',
            data: {
              saved: true,
            }
          });
          assert.isUndefined(e.detail.result);
        });

        test('Has a promise', function() {
          waitUntilFileEvent((e) => {
            e.preventDefault();
          });
          const e = fire({
            options: {
              provider: 'file',
              file: 'file-123'
            },
            data: {
              saved: true,
            }
          });
          assert.typeOf(e.detail.result.then, 'function');
          return e.detail.result;
        });

        test('Creates an export object with saved data', function(done) {
          waitUntilFileEvent((e) => {
            e.preventDefault();
            const data = e.detail.content;
            assert.typeOf(data.requests, 'array');
            assert.lengthOf(data.requests, 5);
            done();
          });
          const e = fire({
            options: {
              provider: 'file',
              file: 'file-123'
            },
            data: {
              saved: true,
            }
          });
          e.detail.result
          .catch((cause) => done(cause));
        });

        test('Creates export object with existing data', function(done) {
          waitUntilFileEvent((e) => {
            e.preventDefault();
            const data = e.detail.content;
            assert.typeOf(data.history, 'array');
            assert.lengthOf(data.history, 1);
            done();
          });
          const e = fire({
            options: {
              provider: 'file',
              file: 'arc-history-export.json',
              kind: 'ARC#HistoryExport'
            },
            data: {
              history: [{
                _id: 'test',
                url: 'https://domain.com',
                type: 'history',
                headers: 'x-a: b',
                method: 'GET'
              }]
            }
          });
          e.detail.result
          .catch((cause) => done(cause));
        });

        test('Exports data to Drive', function(done) {
          waitUntilDriveEvent((e) => {
            e.preventDefault();
            const data = e.detail.content;
            assert.typeOf(data.requests, 'array');
            assert.lengthOf(data.requests, 5);
            assert.equal(e.detail.file, 'test-file');
            assert.equal(e.detail.options.contentType, 'application/json');
            done();
          });
          const e = fire({
            options: {
              provider: 'drive',
              file: 'test-file'
            },
            data: {
              saved: true,
            }
          });
          e.detail.result
          .catch((cause) => done(cause));
        });

        test('Calls dataExport() for export-data', function(done) {
          const spy = sinon.spy(element, 'dataExport');
          waitUntilFileEvent((e) => {
            e.preventDefault();
            assert.isTrue(spy.called);
            done();
          });

          fire({
            destination: 'file',
            file: 'test-file',
            data: {
              test: true
            }
          }, 'export-data');
        });
      });
    });
    </script>

  </body>
</html>
