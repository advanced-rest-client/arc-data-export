<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../chance/dist/chance.min.js"></script>
    <link rel="import" href="../../app-pouchdb/pouchdb.html">
    <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
    <link rel="import" href="../arc-data-export.html">
  </head>
  <body>

    <test-fixture id="Basic">
      <template>
        <arc-data-export></arc-data-export>
      </template>
    </test-fixture>

    <script>
    /* global DataGenerator, chance */
    suite('Basic', function() {
      function mockRev(data) {
        return data.map((item) => {
          item._rev = chance.string();
          return item;
        });
      }
      let element;
      suite('_isAllowedExport()', function() {
        setup(function() {
          element = fixture('Basic');
        });

        test('Passes test for equal string attributes', function() {
          const result = element._isAllowedExport('a', 'a');
          assert.isTrue(result);
        });

        test('Do not passes test for not equal string attributes', function() {
          const result = element._isAllowedExport('a', 'b');
          assert.isFalse(result);
        });

        test('Passes test if type is in array', function() {
          const result = element._isAllowedExport(['a', 'b', 'c'], 'a');
          assert.isTrue(result);
        });

        test('Do not passes test if type is not in array', function() {
          const result = element._isAllowedExport(['a', 'b', 'c'], 'd');
          assert.isFalse(result);
        });

        test('Passes test if exportType equals "all"', function() {
          const result = element._isAllowedExport('all');
          assert.isTrue(result);
        });
      });

      suite('_getDatabasesInfo()', function() {
        setup(function() {
          element = fixture('Basic');
        });

        test('Returns empty object for not defined type', function() {
          const result = element._getDatabasesInfo();
          assert.lengthOf(Object.keys(result), 0);
        });

        test('Returns mapping for a single database', function() {
          const result = element._getDatabasesInfo('history');
          assert.typeOf(result['history-requests'], 'string');
          assert.lengthOf(Object.keys(result), 1);
        });

        test('Returns mapping for projects and saved requests', function() {
          const result = element._getDatabasesInfo('saved');
          assert.equal(result['saved-requests'], 'requests');
          assert.equal(result['legacy-projects'], 'projects');
          assert.lengthOf(Object.keys(result), 2);
        });

        test('Returns mapping for defined data types', function() {
          const types = [
            'history',
            'url-history',
            'websocket',
            'variables',
            'headers-sets',
            'auth',
            'cookies',
            'host-rules'
          ];
          const result = element._getDatabasesInfo(types);
          assert.equal(result['history-requests'], 'history');
          assert.equal(result['websocket-url-history'], 'websocket-url-history');
          assert.equal(result['url-history'], 'url-history');
          assert.equal(result['headers-sets'], 'headers-sets');
          assert.equal(result['auth-data'], 'auth-data');
          assert.equal(result['host-rules'], 'host-rules');
          assert.equal(result.variables, 'variables');
          assert.equal(result.cookies, 'cookies');
          assert.lengthOf(Object.keys(result), types.length);
        });
      });

      suite('_prepareRequestsList()', function() {
        let data;

        setup(function() {
          element = fixture('Basic');
          const projects = DataGenerator.generateProjects({
            projectsSize: 20
          });
          data = DataGenerator.generateRequests({
            requestsSize: 20,
            projects: projects
          });
          data = mockRev(data);
        });

        test('Result is an array', function() {
          const result = element._prepareRequestsList(data);
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed', function() {
          const result = element._prepareRequestsList(data);
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
          }
        });

        test('key is set', function() {
          const result = element._prepareRequestsList(data);
          for (let i = 0, len = result.length; i < len; i++) {
            assert.typeOf(result[i].key, 'string');
          }
        });

        test('legacyProject is removed', function() {
          data[0].legacyProject = 'abc';
          delete data[0].projects;
          const result = element._prepareRequestsList(data);
          assert.isUndefined(result[0].legacyProject);
        });

        test('Adds legacyProject to projects', function() {
          data[0].legacyProject = 'abc';
          delete data[0].projects;
          const result = element._prepareRequestsList(data);
          assert.typeOf(result[0].projects, 'array');
          assert.equal(result[0].projects[0], 'abc');
        });

        test('kind property is set', function() {
          const result = element._prepareRequestsList(data);
          assert.equal(result[0].kind, 'ARC#RequestData');
        });
      });

      suite('_prepareProjectsList()', function() {
        let data;

        setup(function() {
          element = fixture('Basic');
          data = DataGenerator.generateProjects({
            projectsSize: 5
          });
          data = mockRev(data);
        });

        test('Result is an array', function() {
          const result = element._prepareProjectsList(data);
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed', function() {
          const result = element._prepareProjectsList(data);
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
          }
        });

        test('key is set', function() {
          const ids = data.map((item) => item._id);
          const result = element._prepareProjectsList(data);
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i].key !== ids[i]) {
              throw new Error('Key is not set');
            }
          }
        });

        test('kind property is set', function() {
          const result = element._prepareProjectsList(data);
          assert.equal(result[0].kind, 'ARC#ProjectData');
        });
      });

      suite('_prepareHistoryDataList()', function() {
        let result;

        setup(function() {
          element = fixture('Basic');
          let data = DataGenerator.generateHistoryRequestsData();
          data = mockRev(data);
          result = element._prepareHistoryDataList(data);
        });

        test('Result is an array', function() {
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
          }
        });

        test('kind property is set', function() {
          assert.equal(result[0].kind, 'ARC#HistoryData');
        });
      });

      suite('_prepareVariablesData()', function() {
        let result;

        setup(function() {
          element = fixture('Basic');
          let data = DataGenerator.generateVariablesData();
          data = mockRev(data);
          result = element._prepareVariablesData(data);
        });

        test('Result is an array', function() {
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
          }
        });

        test('Contains key property', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            assert.typeOf(result[i].key, 'string');
          }
        });

        test('kind property is set', function() {
          assert.equal(result[0].kind, 'ARC#Variable');
        });
      });

      suite('_prepareHeadersSetsData()', function() {
        let result;

        setup(function() {
          element = fixture('Basic');
          let data = DataGenerator.generateHeadersSetsData();
          data = mockRev(data);
          result = element._prepareHeadersSetsData(data);
        });

        test('Result is an array', function() {
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
          }
        });

        test('Contains key property', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            assert.typeOf(result[i].key, 'string');
          }
        });

        test('kind property is set', function() {
          assert.equal(result[0].kind, 'ARC#HeadersSet');
        });
      });

      suite('_prepareWsUrlHistoryData()', function() {
        let result;

        setup(function() {
          element = fixture('Basic');
          let data = DataGenerator.generateUrlsData();
          data = mockRev(data);
          result = element._prepareWsUrlHistoryData(data);
        });

        test('Result is an array', function() {
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed, key is added', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
            if (!result[i].key) {
              throw new Error('key is not set');
            }
          }
        });

        test('kind property is set', function() {
          assert.equal(result[0].kind, 'ARC#WebsocketHistoryData');
        });
      });

      suite('_prepareUrlHistoryData()', function() {
        let result;

        setup(function() {
          element = fixture('Basic');
          let data = DataGenerator.generateUrlsData();
          data = mockRev(data);
          result = element._prepareUrlHistoryData(data);
        });

        test('Result is an array', function() {
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed, key is added', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
            if (!result[i].key) {
              throw new Error('key is not set');
            }
          }
        });

        test('kind property is set', function() {
          assert.equal(result[0].kind, 'ARC#UrlHistoryData');
        });
      });

      suite('_prepareAuthData()', function() {
        let result;

        setup(function() {
          element = fixture('Basic');
          let data = DataGenerator.generateBasicAuthData();
          data = mockRev(data);
          result = element._prepareAuthData(data);
        });

        test('Result is an array', function() {
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed, key is added', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
            if (!result[i].key) {
              throw new Error('key is not set');
            }
          }
        });

        test('kind property is set', function() {
          assert.equal(result[0].kind, 'ARC#AuthData');
        });
      });

      suite('_prepareCookieData()', function() {
        let result;

        setup(function() {
          element = fixture('Basic');
          let data = DataGenerator.generateCookiesData();
          data = mockRev(data);
          result = element._prepareCookieData(data);
        });

        test('Result is an array', function() {
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed, key is added', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
            if (!result[i].key) {
              throw new Error('key is not set');
            }
          }
        });

        test('kind property is set', function() {
          assert.equal(result[0].kind, 'ARC#Cookie');
        });
      });

      suite('_prepareHostRulesData()', function() {
        let result;

        setup(function() {
          element = fixture('Basic');
          let data = DataGenerator.generateHostRulesData();
          data = mockRev(data);
          result = element._prepareHostRulesData(data);
        });

        test('Result is an array', function() {
          assert.typeOf(result, 'array');
        });

        test('_rev and _id is removed, key is added', function() {
          for (let i = 0, len = result.length; i < len; i++) {
            if (result[i]._id) {
              throw new Error('_id is set');
            }
            if (result[i]._rev) {
              throw new Error('_rev is set');
            }
            if (!result[i].key) {
              throw new Error('key is not set');
            }
          }
        });

        test('kind property is set', function() {
          assert.equal(result[0].kind, 'ARC#HostRule');
        });
      });

      suite('createExportObject', function() {
        let opts = {};

        setup(function() {
          element = fixture('Basic');
          opts.cookies = mockRev(DataGenerator.generateCookiesData());
          opts['auth-data'] = mockRev(DataGenerator.generateBasicAuthData());
          opts['url-history'] = mockRev(DataGenerator.generateUrlsData());
          opts['websocket-url-history'] = mockRev(DataGenerator.generateUrlsData());
          opts['headers-sets'] = mockRev(DataGenerator.generateHeadersSetsData());
          opts.variables = mockRev(DataGenerator.generateVariablesData());
          opts.history = mockRev(DataGenerator.generateHistoryRequestsData());
          opts['host-rules'] = mockRev(DataGenerator.generateHostRulesData());
          const projects = DataGenerator.generateProjects({
            projectsSize: 20
          });
          const requests = DataGenerator.generateRequests({
            requestsSize: 20,
            projects: projects
          });
          opts.projects = mockRev(projects);
          opts.requests = mockRev(requests);
        });

        test('Sets createdAt property', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result.createdAt, 'string');
        });

        test('Default version is set', function() {
          const result = element.createExportObject(opts);
          assert.equal(result.version, 'unknown');
        });

        test('Sets version from attribute', function() {
          element.appVersion = 'test-version';
          const result = element.createExportObject(opts);
          assert.equal(result.version, 'test-version');
        });

        test('Cookies are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result.cookies, 'array');
          assert.lengthOf(result.cookies, opts.cookies.length);
          assert.isUndefined(result.cookies[0]._rew, 'Array was processed');
        });

        test('auth-data are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result['auth-data'], 'array');
          assert.lengthOf(result['auth-data'], opts['auth-data'].length);
          assert.isUndefined(result['auth-data'][0]._rew, 'Array was processed');
        });

        test('url-history are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result['url-history'], 'array');
          assert.lengthOf(result['url-history'], opts['url-history'].length);
          assert.isUndefined(result['url-history'][0]._rew, 'Array was processed');
        });

        test('websocket-url-history are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result['websocket-url-history'], 'array');
          assert.lengthOf(result['websocket-url-history'], opts['websocket-url-history'].length);
          assert.isUndefined(result['websocket-url-history'][0]._rew, 'Array was processed');
        });

        test('headers-sets are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result['headers-sets'], 'array');
          assert.lengthOf(result['headers-sets'], opts['headers-sets'].length);
          assert.isUndefined(result['headers-sets'][0]._rew, 'Array was processed');
        });

        test('variables are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result.variables, 'array');
          assert.lengthOf(result.variables, opts.variables.length);
          assert.isUndefined(result.variables[0]._rew, 'Array was processed');
        });

        test('history are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result.history, 'array');
          assert.lengthOf(result.history, opts.history.length);
          assert.isUndefined(result.history[0]._rew, 'Array was processed');
        });

        test('projects are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result.projects, 'array');
          assert.lengthOf(result.projects, opts.projects.length);
          assert.isUndefined(result.projects[0]._rew, 'Array was processed');
        });

        test('requests are set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result.requests, 'array');
          assert.lengthOf(result.requests, opts.requests.length);
          assert.isUndefined(result.requests[0]._rew, 'Array was processed');
        });

        test('host-rules is set', function() {
          const result = element.createExportObject(opts);
          assert.typeOf(result['host-rules'], 'array');
          assert.lengthOf(result['host-rules'], opts['host-rules'].length);
          assert.isUndefined(result['host-rules'][0]._rew, 'Array was processed');
        });
      });
    });
    </script>
  </body>
</html>
